#!/usr/bin/perl
use POSIX qw(strftime);

sub process {
  my $p=$_[0];
  my $DIRS;

  if(-d "$p/current") {
    @s=stat("$p/current");
    $current=strftime("%Y%m%d", localtime($s[9]))."\n";

    system("cd $p ; mmv \"2008*\" \"old_2008#1\"");
    system("cd $p ; mmv \"M200*\" \"200#1\"");
    system("cd $p ; mv current $current ; ln -s $current last_backup");
    system("cd $p ; mv statistic.current.progress statistic.last_backup.progress");
  }
  else {
    opendir($DIRS, $p);
    while($r=readdir($DIRS)) {
      if($r !~ /^\./) {
	process("$p/$r", $keep);
      }
    }
    closedir($DIRS);
  }
}

process("/backup-cg");
